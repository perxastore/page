<!DOCTYPE html>
<html>
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="./images/logo.png">
    <meta charset="UTF-8" />
    <title>Perxa - Prendas</title>
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
        import { query, where, getFirestore, collection, onSnapshot, doc, getDoc} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  

        const firebaseConfig = {
        apiKey: "AIzaSyB7FJ8jzZgv4I4RW9-B6Q3U-RiZ0_ON_fg",
        authDomain: "perxa-e9bb2.firebaseapp.com",
        databaseURL: "https://perxa-e9bb2-default-rtdb.firebaseio.com",
        projectId: "perxa-e9bb2",
        storageBucket: "perxa-e9bb2.firebasestorage.app",
        messagingSenderId: "784850450102",
        appId: "1:784850450102:web:110962deb6e693aec19817",
        measurementId: "G-DMVEXWBG3L"
        };


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const configRef = doc(db, "configs", "global");
        let globalDiscount = 1;
        onSnapshot(configRef, (snap) => {
        if (snap.exists()) {
            console.log("Updated config:", snap.data());
            globalDiscount = snap.data().globalDiscount;
        }
        });
        
        const params = new URLSearchParams(window.location.search);

        const filters = {};

        params.forEach((value, key) => {
        filters[key] = value;
        });


        let pageTitle = params.values().next().value;
        if (pageTitle == "true"){pageTitle = "SelecciÃ³n"}
        if (!pageTitle) {pageTitle = "Todo"}

        document.getElementById("title").textContent = pageTitle;


        const galleryDiv = document.getElementById("galleryContainer");
        let q = query(collection(db, "items"));

        Object.keys(filters).forEach((key) => {
            if (key == "featured" && filters[key] == "true"){
                filters[key] = true;
            }
            q = query(q, where(key, "==", filters[key]));
        });

        onSnapshot(q, (snapshot) => {
            galleryDiv.innerHTML = "";
            snapshot.forEach(doc => {
                const item = doc.data();
                if (item.status != "Vendido"){
                    const img = item.images?.[0] || "";
                    let priceHTML = "";
                    if (globalDiscount<1){
                        priceHTML = `<h2 style="font-size: 48px"><s>Q${item.price}</s> Q${item.price * globalDiscount}</h2>`;
                    }else if (globalDiscount == 1){
                        priceHTML = `<h2 style="font-size: 48px">Q${item.price}</h2>`;
                    }
                    galleryDiv.innerHTML += `
                    <div class="card" onclick="window.location.href='./item.html?id=${doc.id}'">
                        <h5>${item.id}</h5>
                        <img src="${img}" loading="lazy">
                        ${priceHTML}
                        <h2>Talla ${item.size}</h2>
                    </div>`;
                }
            });
        });

    </script>

    <div id="mainCard" style="padding: 32px;">
        <div class="columnContainer">
            <div id="mainTitle">
                <h1 id="title"></h1>
            </div>
            <div id="galleryContainer" >
            
            </div>
        </div>
        
    </div>
    
    

</body>
</html>